{{ 'section-announcement-bar.css' | asset_url | stylesheet_tag }}

{%- assign marquee_slide_blocks = section.blocks | where: 'type', 'marquee_slide' -%}
{%- assign link_blocks = section.blocks | where: 'type', 'link' -%}

<div class="announcement-bar" role="region" aria-label="{{ 'sections.header.announcement' | t }}">
  <div class="announcement-bar__wrapper page-width">
    
    {%- if marquee_slide_blocks.size > 0 -%}
      <div class="announcement_bar__marquee">
        <div class="marquee__track-container">
          <ul class="marquee__content">
            {%- for block in marquee_slide_blocks -%}
              <li class="marquee__item">
                {%- if block.settings.icon != 'none' -%}
                  {% render 'icon', icon: block.settings.icon %}
                  <span class="visual-hidden">Icon</span>
                {%- endif -%}
                <span>{{ block.settings.content }}</span>
              </li>
            {%- endfor -%}
          </ul>
        </div>
      </div>

      <script>
        function initMarquee() {
          const containers = document.querySelectorAll('.announcement_bar__marquee');
          
          containers.forEach(container => {
            // Check if already initialized to avoid duplicates on re-runs
            if (container.querySelector('.marquee__track')) return;

            const contentList = container.querySelector('.marquee__content');
            if (!contentList) return;

            // 1. Clone items until the list is sufficiently wide
            // Ensure we have enough content to fill screen + buffer
            let contentWidth = contentList.offsetWidth;
            const items = Array.from(contentList.children);
            
            // Safety break to prevent infinite loops if width is 0
            if (contentWidth === 0) contentWidth = window.innerWidth || 1000;

            let loops = 0;
            while (contentWidth < window.innerWidth * 1.5 && loops < 20) {
                items.forEach(item => {
                    contentList.appendChild(item.cloneNode(true));
                });
                contentWidth = contentList.offsetWidth;
                loops++;
            }

            // 2. Wrap in track
            const wrapper = document.createElement('div');
            wrapper.className = 'marquee__track';
            
            // Clone for seamless loop
            const cloneList = contentList.cloneNode(true);
            cloneList.setAttribute('aria-hidden', 'true');
            
            // Structure: Track -> [Original List, Clone List]
            contentList.parentNode.insertBefore(wrapper, contentList);
            wrapper.appendChild(contentList);
            wrapper.appendChild(cloneList);
            
            // 3. Set Animation Speed
            // 3. Set Animation Speed
            // Reduced speed drastically as requested
            const speed = 8; 
            const duration = contentWidth / speed;
            
            // Apply animation directly
            wrapper.style.animation = `marquee ${duration}s linear infinite`;
          });
        }

        // Run on load to ensure widths are correct
        if (document.readyState === 'complete') {
            initMarquee();
        } else {
            window.addEventListener('load', initMarquee);
        }
      </script>
    {%- endif -%}

    {%- for block in link_blocks -%}
      <a href="{{ block.settings.link }}" class="announcement-bar__static-link">
        {%- if block.settings.custom_icon != blank -%}
             <img src="{{ block.settings.custom_icon | image_url: width: 20 }}" alt="{{ block.settings.link_label }}" width="20" height="20">
        {%- elsif block.settings.icon != 'none' -%}
            {% render 'icon', icon_name: block.settings.icon %}
        {%- endif -%}
        {{ block.settings.link_label }}
      </a>
    {%- endfor -%}

  </div>
</div>

{% schema %}
{
  "name": "Custom Announcement Bar",
  "settings": [
    {
      "type": "color",
      "id": "color_bg",
      "label": "Background Color",
      "default": "#A3CA6D"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Text Color",
      "default": "#FFFFFF"
    }
  ],
  "blocks": [
    {
      "type": "marquee_slide",
      "name": "Marquee Text",
      "settings": [
        {
          "type": "text",
          "id": "content",
          "label": "Text",
          "default": "Welcome to our store"
        },
        {
          "type": "text",
          "id": "icon",
          "label": "Icon Name (optional)",
          "default": "none"
        }
      ]
    },
    {
      "type": "link",
      "name": "Static Link",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "link_label",
          "label": "Label",
          "default": "New Products"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "icon",
          "label": "Icon Name",
          "default": "star"
        },
        {
           "type": "image_picker",
           "id": "custom_icon",
           "label": "Custom Icon"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Announcement Bar",
      "blocks": [
        {
          "type": "marquee_slide"
        },
        {
           "type": "link"
        }
      ]
    }
  ]
}
{% endschema %}
